#!/usr/bin/env ruby

class ServerDeploy

  def initialize(args)
    @app_dir     = File.expand_path('../../', __FILE__)
    @environment = 'production'
  end

  def deploy
    if ENV['USER'] != 'passmaster'
      puts 'This script should be run as the passmaster user.'
      return
    end

    Dir.chdir(@app_dir) do
      system "git checkout --quiet master"
      system "git pull --quiet"
      system "git checkout #{@environment}"
      system "git reset --hard origin/#{@environment}"
      system "bundle install --quiet --deployment --without=development test staging"
      system "script/unicorn start #{@environment}"
    end
  end

end

ServerDeploy.new(ARGV).deploy
